#!/bin/bash

  ##############################################
  # Helper methods
  ##############################################
  updateBest() {
    bestActionScore=$1
    bestResourceScore=$2
    bestImplScore=$3
    bestResourceId=$4
  }


  ##############################################
  # MAIN
  ##############################################
  runtimelog=$1

  scoresList=$(cat $runtimelog | egrep -A 4 "Scheduling.*execution:")
  
  while read -r line; do
    #PARSE LINE
    taskId=$(echo $line | tr " " "\n" | sed -n 10p | rev | cut -c 2- | rev)
    
    # Next 4 lines are the resources
    i=0
    bestActionScore="null"
    bestResourceScore=0
    bestImplScore=0
    bestResourceId="null"
    while [ $i -lt 4 ]; do
      read -r resource
      # Get scores 
      resourceId=$(echo $resource | tr " " "\n" | sed -n 2p)
      actionScore=$(echo $resource | tr " " "\n" | sed -n 6p)
      resourceScore=0
      implScore=0
      if [ "$actionScore" != "null" ]; then
        actionScore=$(echo $actionScore | tr ":" " " | tr "," " " | awk {' print $2 '})
        resourceScore=$(echo $resource | tr " " "\n" | sed -n 7p | tr ":" " " | tr "," " " | awk {' print $2 '})
        implScore=$(echo $resource | tr " " "\n" | sed -n 8p | tr ":" " " | tr "," " " | tr "]" " " | awk {' print $2 '})
      fi

      # Update best
      if [ "$actionScore" != "null" ]; then
        if [ "$bestActionScore" == "null" ]; then
          updateBest $actionScore $resourceScore $implScore $resourceId
        else
          if [ $actionScore -gt $bestActionScore ]; then
            updateBest $actionScore $resourceScore $implScore $resourceId
          elif [ $actionScore -eq $bestActionScore ]; then
            if [ $resourceScore -gt $bestResourceScore ]; then
              updateBest $actionScore $resourceScore $implScore $resourceId
            elif [ $resourceScore -eq $bestResourceScore ]; then
              if [ $implScore -ge $bestImplScore ]; then
                updateBest $actionScore $resourceScore $implScore $resourceId
              fi
            fi
          fi
        fi
      fi
      i=$((i+1))
    done
    # If task had no resource, look for forced schedule message
    if [ "$bestActionScore" == "null" ]; then
     bestResourceId=$(cat $runtimelog | egrep "Scheduling SingleExecution \( Task ${taskId},.*execution for worker" | awk {' print $17 '} | tr "@" " " | tr ":" " " | awk {' print $2 '})
    fi
    
    # Print result
    echo "$taskId $bestResourceId"

    # Skip grep sep line
    read -r skip
  done <<< "$scoresList"
  
  # End
  exit 0
  