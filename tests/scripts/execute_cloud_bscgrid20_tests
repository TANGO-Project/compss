#!/bin/bash

  #--------------------------------------------------------------------------------
  #Set global variables
  COMPSs_exec=$1
  comm=$2
  num_test=$3
  master_template_id=$4
  os_type=$5
  cloud_owner=$6
 
  user=user
  base_dir="/home/$user/tests"
  cloud_base_dir="${base_dir}/apps_cloud"
  COMPSs_log_folder="/home/$user/.COMPSs"
  base_log_folder="$base_dir/logs"

  exitValue=0

  #--------------------------------------------------------------------------------
  echo "**Setting JAVA_HOME and IT_HOME"
  sudo sh -c "echo 'export JAVA_HOME=/usr/lib/jvm/default-java' >> /etc/profile"
  sudo sh -c "echo 'export IT_HOME=/opt/COMPSs/Runtime' >> /etc/profile"
  source /etc/profile 

  #--------------------------------------------------------------------------------
  echo
  echo "**Testing Cloud Block App ${num_test}"
 
  if [ "${num_test}" = "all" ]; then
     app_folders=$(ls ${cloud_base_dir})
     appCounter=1
     results=""
     for app in ${app_folders}; do
        log_folder="${base_log_folder}/$app"
        mkdir -p ${log_folder}
        cd ${cloud_base_dir}/$app
        ./execution ${COMPSs_exec} ${comm} "${cloud_base_dir}/$app" ${COMPSs_log_folder} ${log_folder} ${master_template_id} ${os_type} ${cloud_owner}
        if [ $? -ne 0 ]; then
           exitValue=1
           results="${results}1"
        else
           results="${results}0"
        fi
        # Sleep to avoid interferences between tests
        sleep 1
        appCounter=$((appCounter+1))
     done

     #Show Result table
     counter=1
     pos=0
     echo
     echo -e "\e[34m------------------------------------------------------------------------"
     echo -e "\e[34m------------------------------------------------------------------------"
     echo -e "\e[34m   Application Name                                      TEST STATUS"
     while [ $counter -lt $appCounter ]; do
       if [ "${results:$pos:1}" == "0" ]; then
          echo -e "\e[34m [TEST RESULT] Application CLOUD BLOCK $counter ..................... \e[32mOK"
       else
          echo -e "\e[34m [TEST RESULT] Application CLOUD BLOCK $counter ..................... \e[31mERROR"
       fi
       counter=$((counter+1))
       pos=$((pos+1))
     done  
     echo -e "\e[34m"
     echo -e "\e[34m------------------------------------------------------------------------"
     echo -e "\e[34m------------------------------------------------------------------------" 
     echo -e "\e[34mIf there are errors, please check the log files"
     echo -e "\e[0m"
  else
     results=""
     app="app0${num_test}"
     log_folder="${base_log_folder}/$app"
     mkdir -p ${log_folder}
     cd ${cloud_base_dir}/$app
     ./execution ${COMPSs_exec} $comm "${cloud_base_dir}/$app" ${COMPSs_log_folder} ${log_folder} ${master_template_id} ${os_type} ${cloud_owner}
     if [ $? -ne 0 ]; then
        exitValue=1
        results="1"
     else
        results="0"
     fi

     #Show Result table
     echo
     echo -e "\e[34m------------------------------------------------------------------------"
     echo -e "\e[34m------------------------------------------------------------------------"
     echo -e "\e[34m   Application Name                                      TEST STATUS"
     if [ "$results" == "0" ]; then
        echo -e "\e[34m [TEST RESULT] Application CLOUD BLOCK ${num_test} ..................... \e[32mOK"
     else
        echo -e "\e[34m [TEST RESULT] Application CLOUD BLOCK ${num_test} ..................... \e[31mERROR"
     fi
     echo -e "\e[34m"
     echo -e "\e[34m------------------------------------------------------------------------"
     echo -e "\e[34m------------------------------------------------------------------------" 
     echo -e "\e[34mIf there are errors, please check the log files"
     echo -e "\e[0m"
  fi 
  #--------------------------------------------------------------------------------
  #EXIT
  exit $exitValue

